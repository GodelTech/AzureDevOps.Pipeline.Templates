parameters:
  vmImage: 'ubuntu-latest'
  stageName: 'N/A'
  stageDisplayName: 'Deploy stage'
  environment: 'N/A'
  dependsOn: 'N/A'
  appName: 'N/A'
  azureSubscription: 'N/A'
  resourceGroupName: 'N/A'
  appSettings: ''
  generalSettings: ''
  connectionStrings: ''

stages:
- stage: ${{ parameters.stageName }}
  displayName: '${{ parameters.stageDisplayName }}'
  dependsOn: ${{ parameters.dependsOn }}
  pool:
    vmImage: ${{ parameters.vmImage }}
  jobs:
  - deployment: Deploy
    displayName: 'Deploy'
    environment: ${{ parameters.environment }}
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureAppServiceSettings@1
            displayName: 'Replace config values'
            condition: or(ne('${{ parameters.appSettings }}', ''), ne('${{ parameters.generalSettings }}', ''), ne('${{ parameters.connectionStrings }}', ''))
            inputs:
              azureSubscription: ${{ parameters.azureSubscription }}
              appName: ${{ parameters.appName }}
              resourceGroupName: ${{ parameters.resourceGroupName }}
              appSettings: ${{ parameters.appSettings }}
              generalSettings: ${{ parameters.generalSettings }}
              connectionStrings: ${{ parameters.connectionStrings }}

          - task: AzureRmWebAppDeployment@4
            displayName: 'Deploy in App Services'
            inputs:
              ConnectionType: 'AzureRM'
              azureSubscription: ${{ parameters.azureSubscription }}
              appType: 'apiApp'
              WebAppName: ${{ parameters.appName }}
              packageForLinux: '$(Pipeline.Workspace)/**/*.zip'
