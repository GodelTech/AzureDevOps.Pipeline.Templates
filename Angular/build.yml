parameters:
- name: buildConfiguration
  displayName: 'Build configuration'
  type: string
  default: 'production'

- name: preBuildSteps
  displayName: 'Steps to run before build'
  type: stepList
  default: []

- name: appName
  displayName: 'Angular application name'
  type: string
  default: 'app'

- name: appSourcePath
  displayName: 'Angular application source path'
  type: string
  default: 'src'

- name: enableSonarCloud
  displayName: 'Enable SonarCloud'
  type: boolean
  default: true

- name: sonarCloudOrganizationName
  displayName: 'Organization name for SonarCloud'
  type: string
  default: ''

- name: sonarCloudProjectKey
  displayName: 'Project key for SonarCloud'
  type: string
  default: ''

- name: sonarCloudProjectName
  displayName: 'Project name for SonarCloud'
  type: string
  default: ''

- name: checkWarnings
  displayName: 'Check warnings'
  type: boolean
  default: true

- name: checkCoverage
  displayName: 'Check code coverage'
  type: boolean
  default: true

- name: includeSonarcloudBuildBreaker
  displayName: 'Does Sonarcloud build breaker turn on?'
  type: boolean
  default: true

steps:
- ${{ each step in parameters.preBuildSteps }}:
  - ${{ each pair in step }}:
      ${{ if ne(pair.value, 'CmdLine@2') }}:
        ${{ pair.key }}: ${{ pair.value }}       
      ${{ if eq(pair.value, 'CmdLine@2') }}: 
        # Step is rejected by raising a YAML syntax error: Unexpected value 'CmdLine@2'
        '${{ pair.value }}': error

- task: SonarCloudPrepare@1
  displayName: 'Prepare analysis on SonarCloud'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.enableSonarCloud }}, true)
    )
  inputs:
    SonarCloud: 'SonarCloud'
    organization: '${{ parameters.sonarCloudOrganizationName }}'
    scannerMode: CLI
    projectKey: '${{ parameters.sonarCloudProjectKey }}'
    projectName: '${{ parameters.sonarCloudProjectName }}'
    cliSources: '$(Build.SourcesDirectory)'
    cliProjectKey: $(Build.Repository.Name)
    configMode: manual
    extraProperties: |
      sonar.sources=${{ parameters.appSourcePath }}
      sonar.tests=${{ parameters.appSourcePath }}
      sonar.test.inclusions=${{ parameters.appSourcePath }}/**/*.spec.ts
      sonar.exclusions=${{ parameters.appSourcePath }}/**/*.spec.ts
      sonar.coverage.exclusions=${{ parameters.appSourcePath }}/bootstrap.ts,${{ parameters.appSourcePath }}/main.ts,${{ parameters.appSourcePath }}/polyfills.ts,${{ parameters.appSourcePath }}/test.ts,${{ parameters.appSourcePath }}/**/*environment*.ts,${{ parameters.appSourcePath }}/**/*module.ts
      sonar.javascript.lcov.reportPaths=$(Build.SourcesDirectory)/coverage/${{ parameters.appName }}/lcov/lcov.info
      sonar.testExecutionReportPaths=$(Build.SourcesDirectory)/TestResults/${{ parameters.appName }}/SonarQube/SonarQube.xml

- task: NodeTool@0
  displayName: 'Install Node.js 16.x'
  inputs:
    versionSpec: '16.x'
    checkLatest: true

- task: Npm@1
  displayName: 'Install Angular CLI'
  inputs:
    command: 'custom'
    customCommand: 'install -g @angular/cli'

- task: Npm@1
  displayName: 'Install packages'
  inputs:
    command: 'ci'

- task: Npm@1
  displayName: 'Build'
  inputs:
    command: 'custom'
    customCommand:
      '
        run ng build ${{ parameters.appName }}
          --
          --configuration ${{ parameters.buildConfiguration }}
      '

- task: Npm@1
  displayName: "Run lint"
  inputs:
    command: 'custom'
    customCommand: 'run ng lint ${{ parameters.appName }}'

- task: Npm@1
  displayName: 'Run unit tests'
  inputs:
    command: 'custom'
    customCommand:
      '
        run ng test ${{ parameters.appName }}
          --
          --browsers=ChromeHeadless
          --code-coverage=true
          --watch=false
      '

- task: PublishTestResults@2
  displayName: "Publish test results"
  condition: succeededOrFailed()
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(Build.SourcesDirectory)/TestResults/${{ parameters.appName }}/junit/TESTS*.xml'
    mergeTestResults: true

- task: PublishCodeCoverageResults@1
  displayName: 'Publish code coverage reports'
  condition: succeededOrFailed()
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(Build.SourcesDirectory)/coverage/${{ parameters.appName }}/cobertura/cobertura-coverage.xml'

- task: SonarCloudAnalyze@1
  displayName: 'Run Code Analysis'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.enableSonarCloud }}, true)
    )

- task: SonarCloudPublish@1
  displayName: 'Publish Quality Gate Result'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.enableSonarCloud }}, true)
    )
  inputs:
    pollingTimeoutSec: '300'

- task: BuildQualityChecks@8
  displayName: 'Warnings quality check'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.checkWarnings }}, true)
    )
  inputs:
    checkWarnings: true
    warningFailOption: 'fixed'
    warningThreshold: '0'
    showStatistics: true

- task: BuildQualityChecks@8
  displayName: 'Line Code coverage quality check'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.checkCoverage }}, true)
    )
  inputs:
    checkCoverage: true
    coverageFailOption: 'fixed'
    coverageType: 'lines'
    treat0of0as100: true
    coverageThreshold: '80'

- task: BuildQualityChecks@8
  displayName: 'Branches Code coverage quality check'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.checkCoverage }}, true)
    )
  inputs:
    checkCoverage: true
    coverageFailOption: 'fixed'
    coverageType: 'branches'
    treat0of0as100: true
    coverageThreshold: '80'

- task: sonarcloud-buildbreaker@2
  displayName: 'Break build on quality gate failure'
  condition: |
    and
    (
      succeeded(),
      eq(${{ parameters.enableSonarCloud }}, true),
      eq(${{ parameters.includeSonarcloudBuildBreaker }}, true)
    )
  inputs:
    SonarCloud: 'SonarCloud'
    organization: '${{ parameters.sonarCloudOrganizationName }}'
